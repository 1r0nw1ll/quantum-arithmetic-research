{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "QA_GRAPH_STRUCTURE_CERT.v1.schema.json",
  "title": "QA Graph Structure Certificate v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "certificate_id",
    "certificate_type",
    "timestamp",
    "version",
    "schema",
    "success",
    "generator_set"
  ],
  "properties": {
    "certificate_id": { "type": "string", "minLength": 1 },
    "certificate_type": { "type": "string", "const": "GRAPH_STRUCTURE_CERT" },
    "timestamp": { "type": "string", "minLength": 1 },
    "version": { "type": "string", "minLength": 1 },
    "schema": { "type": "string", "const": "QA_GRAPH_STRUCTURE_CERT.v1" },
    "success": { "type": "boolean" },
    "generator_set": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "string",
        "enum": [
          "sigma_feat_extract",
          "sigma_qa_embed",
          "sigma_cluster",
          "sigma_eval",
          "sigma_phase_analyze"
        ]
      },
      "uniqueItems": true
    },
    "graph_context": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "dataset_id",
        "algorithm",
        "node_count",
        "edge_count",
        "community_count",
        "split_seed",
        "clustering_seed"
      ],
      "properties": {
        "dataset_id": { "type": "string", "minLength": 1 },
        "algorithm": { "type": "string", "minLength": 1 },
        "node_count": { "type": "integer", "minimum": 1 },
        "edge_count": { "type": "integer", "minimum": 0 },
        "community_count": { "type": "integer", "minimum": 1 },
        "split_seed": { "type": "integer", "minimum": 0 },
        "clustering_seed": { "type": "integer", "minimum": 0 }
      }
    },
    "metric_witness": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "qa_metrics",
        "baseline_metrics",
        "delta_metrics",
        "delta_non_negative_any"
      ],
      "properties": {
        "qa_metrics": { "$ref": "#/definitions/metrics_object" },
        "baseline_metrics": { "$ref": "#/definitions/metrics_object" },
        "delta_metrics": { "$ref": "#/definitions/metrics_object" },
        "delta_non_negative_any": { "type": "boolean" }
      }
    },
    "phase_witness": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "phase_24_baseline",
        "phase_24_qa",
        "phase_9_baseline",
        "phase_9_qa",
        "phase_preserved"
      ],
      "properties": {
        "phase_24_baseline": { "type": "integer", "minimum": 0, "maximum": 23 },
        "phase_24_qa": { "type": "integer", "minimum": 0, "maximum": 23 },
        "phase_9_baseline": { "type": "integer", "minimum": 0, "maximum": 8 },
        "phase_9_qa": { "type": "integer", "minimum": 0, "maximum": 8 },
        "phase_preserved": { "type": "boolean" }
      }
    },
    "invariants": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "tuple_consistency",
        "feature_determinism",
        "eval_repro",
        "trace",
        "baseline_pairing"
      ],
      "properties": {
        "tuple_consistency": { "type": "boolean" },
        "feature_determinism": { "type": "boolean" },
        "eval_repro": { "type": "boolean" },
        "trace": { "type": "boolean" },
        "baseline_pairing": { "type": "boolean" }
      }
    },
    "recompute_inputs": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "trace_schema",
        "trace_digest",
        "paired_config",
        "baseline_trace",
        "qa_trace"
      ],
      "properties": {
        "trace_schema": { "type": "string", "const": "QA_GRAPH_STRUCTURE_TRACE.v1" },
        "trace_digest": { "type": "string", "pattern": "^sha256:[0-9a-f]{64}$" },
        "paired_config": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "dataset_id",
            "algorithm",
            "split_seed",
            "clustering_seed",
            "baseline_mode",
            "qa_mode"
          ],
          "properties": {
            "dataset_id": { "type": "string", "minLength": 1 },
            "algorithm": { "type": "string", "minLength": 1 },
            "split_seed": { "type": "integer", "minimum": 0 },
            "clustering_seed": { "type": "integer", "minimum": 0 },
            "baseline_mode": { "type": "string", "minLength": 1 },
            "qa_mode": { "type": "string", "minLength": 1 }
          }
        },
        "baseline_trace": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/trace_step" }
        },
        "qa_trace": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/trace_step" }
        }
      }
    },
    "failure_mode": {
      "type": "string",
      "enum": ["out_of_bounds", "invariant", "phase_violation", "parity", "reduction"]
    },
    "failure_witness": {
      "type": "object",
      "additionalProperties": true
    },
    "qa_interpretation": {
      "type": "object",
      "additionalProperties": true
    }
  },
  "allOf": [
    {
      "if": { "properties": { "success": { "const": true } } },
      "then": {
        "required": ["graph_context", "metric_witness", "phase_witness", "invariants", "recompute_inputs"]
      }
    },
    {
      "if": { "properties": { "success": { "const": false } } },
      "then": { "required": ["failure_mode", "failure_witness"] }
    }
  ],
  "definitions": {
    "scalar": {
      "anyOf": [
        { "type": "integer" },
        { "type": "string", "pattern": "^-?[0-9]+(/[0-9]+)?$" }
      ]
    },
    "metrics_object": {
      "type": "object",
      "additionalProperties": false,
      "required": ["ari", "nmi", "modularity", "purity"],
      "properties": {
        "ari": { "$ref": "#/definitions/scalar" },
        "nmi": { "$ref": "#/definitions/scalar" },
        "modularity": { "$ref": "#/definitions/scalar" },
        "purity": { "$ref": "#/definitions/scalar" }
      }
    },
    "trace_step": {
      "type": "object",
      "additionalProperties": false,
      "required": ["step_index", "generator", "stage", "phase_24", "phase_9", "metrics"],
      "properties": {
        "step_index": { "type": "integer", "minimum": 1 },
        "generator": {
          "type": "string",
          "enum": [
            "sigma_feat_extract",
            "sigma_qa_embed",
            "sigma_cluster",
            "sigma_eval",
            "sigma_phase_analyze"
          ]
        },
        "stage": { "type": "string", "minLength": 1 },
        "phase_24": { "type": "integer", "minimum": 0, "maximum": 23 },
        "phase_9": { "type": "integer", "minimum": 0, "maximum": 8 },
        "metrics": { "$ref": "#/definitions/metrics_object" }
      }
    }
  }
}
