name: QA CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  qa-validators:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: qa_alphageometry_ptolemy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install "pytest==8.4.2" "jsonschema>=4.0.0"

      - name: Run QA meta-validator (tetrad + conjectures + FST)
        run: python qa_meta_validator.py

      - name: Run conjecture core checks
        run: python qa_conjecture_core.py

      - name: Run FST validator checks
        run: python qa_fst/qa_fst_validate.py

      - name: Run Agent Security Kernel self-tests
        working-directory: .
        run: python qa_agent_security/qa_agent_security.py

      - name: Run Tool Runner self-tests
        working-directory: .
        run: python -m qa_agent_security.tool_runner

      - name: Run Agent Security Kernel pytest suite
        working-directory: .
        run: python -m pytest qa_agent_security/tests/ -q --override-ini="testpaths=qa_agent_security/tests" --override-ini="python_files=test_*.py"

      - name: Run QA Probes (certified obstruction theorems)
        working-directory: .
        run: python -m pytest qa_probes/ -v --override-ini="testpaths=qa_probes" --override-ini="python_files=test_*.py"
