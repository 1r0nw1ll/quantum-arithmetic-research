{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "QA_RATIONAL_TRIG_TYPE_SYSTEM.v1.schema.json",
  "title": "QA_RATIONAL_TRIG_TYPE_SYSTEM.v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "cert_type",
    "cert_id",
    "created_utc",
    "source_semantics",
    "type_system",
    "rt_core",
    "derivation",
    "determinism_contract"
  ],
  "properties": {
    "schema_version": { "type": "string", "const": "v1" },
    "cert_type": { "type": "string", "const": "QA_RATIONAL_TRIG_TYPE_SYSTEM.v1" },
    "cert_id": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9._-]{8,128}$"
    },
    "created_utc": {
      "type": "string",
      "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
    },
    "source_semantics": {
      "type": "object",
      "additionalProperties": false,
      "required": ["video_ref", "rt_refs"],
      "properties": {
        "video_ref": {
          "type": "object",
          "additionalProperties": false,
          "required": ["url", "timestamp_seconds", "claim_summary"],
          "properties": {
            "url": { "type": "string", "minLength": 1 },
            "timestamp_seconds": { "type": "integer", "minimum": 0 },
            "claim_summary": { "type": "string", "minLength": 1 }
          }
        },
        "rt_refs": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["title", "url_or_citation"],
            "properties": {
              "title": { "type": "string", "minLength": 1 },
              "url_or_citation": { "type": "string", "minLength": 1 }
            }
          }
        }
      }
    },
    "type_system": {
      "type": "object",
      "additionalProperties": false,
      "required": ["base_algebra", "types", "formation_rules"],
      "properties": {
        "base_algebra": {
          "type": "object",
          "additionalProperties": false,
          "required": ["kind", "assumptions"],
          "properties": {
            "kind": {
              "type": "string",
              "enum": ["field", "integral_domain", "commutative_ring", "semiring"]
            },
            "assumptions": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "types": {
          "type": "object",
          "additionalProperties": false,
          "required": ["Point2", "Line2", "Triangle"],
          "properties": {
            "Point2": { "type": "object" },
            "Line2": { "type": "object" },
            "Triangle": { "type": "object" }
          }
        },
        "formation_rules": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["rule_id", "inputs", "outputs", "side_conditions"],
            "properties": {
              "rule_id": { "type": "string", "pattern": "^FR_[A-Z0-9_]{2,64}$" },
              "inputs": { "type": "array", "items": { "type": "string" } },
              "outputs": { "type": "array", "items": { "type": "string" } },
              "side_conditions": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    },
    "rt_core": {
      "type": "object",
      "additionalProperties": false,
      "required": ["primitives", "laws"],
      "properties": {
        "primitives": {
          "type": "object",
          "additionalProperties": false,
          "required": ["quadrance", "spread"],
          "properties": {
            "quadrance": {
              "type": "object",
              "additionalProperties": false,
              "required": ["definition"],
              "properties": { "definition": { "type": "string", "minLength": 1 } }
            },
            "spread": {
              "type": "object",
              "additionalProperties": false,
              "required": ["definition"],
              "properties": { "definition": { "type": "string", "minLength": 1 } }
            }
          }
        },
        "laws": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["law_id", "name", "generator_move", "preconditions", "equation", "outputs"],
            "properties": {
              "law_id": { "type": "string", "pattern": "^RT_LAW_[0-9]{2}$" },
              "name": { "type": "string", "minLength": 1 },
              "generator_move": {
                "type": "string",
                "enum": ["derive", "rewrite", "solve_for", "check_invariant"]
              },
              "preconditions": { "type": "array", "items": { "type": "string" } },
              "equation": { "type": "string", "minLength": 1 },
              "outputs": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    },
    "derivation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["typed_state", "steps"],
      "properties": {
        "typed_state": {
          "type": "object",
          "additionalProperties": false,
          "required": ["triangle", "observables"],
          "properties": {
            "triangle": {
              "type": "object",
              "additionalProperties": false,
              "required": ["A", "B", "C", "non_collinear_proof"],
              "properties": {
                "A": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                "B": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                "C": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 },
                "non_collinear_proof": { "type": "string", "minLength": 1 }
              }
            },
            "observables": {
              "type": "object",
              "additionalProperties": false,
              "required": ["Q1", "Q2", "Q3", "s1", "s2", "s3"],
              "properties": {
                "Q1": { "type": "number" },
                "Q2": { "type": "number" },
                "Q3": { "type": "number" },
                "s1": { "type": "number" },
                "s2": { "type": "number" },
                "s3": { "type": "number" }
              }
            }
          }
        },
        "steps": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["step_id", "uses_law_id", "inputs", "outputs", "deterministic_hash"],
            "properties": {
              "step_id": { "type": "string", "pattern": "^STEP_[0-9]{3,6}$" },
              "uses_law_id": { "type": "string", "pattern": "^RT_LAW_[0-9]{2}$" },
              "inputs": { "type": "object" },
              "outputs": { "type": "object" },
              "deterministic_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
            }
          }
        }
      }
    },
    "determinism_contract": {
      "type": "object",
      "additionalProperties": false,
      "required": ["canonical_json", "no_rng", "stable_sorting", "hash_rule"],
      "properties": {
        "canonical_json": { "type": "boolean", "const": true },
        "no_rng": { "type": "boolean", "const": true },
        "stable_sorting": { "type": "boolean", "const": true },
        "hash_rule": { "type": "string", "minLength": 1 }
      }
    },
    "invariant_diff": {
      "type": "object",
      "additionalProperties": false,
      "required": ["invariants", "diffs"],
      "properties": {
        "invariants": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "value"],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "value": {}
            }
          }
        },
        "diffs": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "before", "after"],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "before": {},
              "after": {}
            }
          }
        }
      }
    }
  }
}
