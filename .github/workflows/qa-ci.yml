name: QA CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  qa-clean-tree-meta-validator:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements-dev.txt

      - name: Fetch MNIST raw files for Level-3 recompute
        run: |
          mkdir -p data/MNIST/raw
          python - <<'PY'
          from pathlib import Path
          from urllib.request import urlretrieve

          base = "https://storage.googleapis.com/cvdf-datasets/mnist/"
          files = [
              "train-images-idx3-ubyte.gz",
              "train-labels-idx1-ubyte.gz",
              "t10k-images-idx3-ubyte.gz",
              "t10k-labels-idx1-ubyte.gz",
          ]

          out_dir = Path("data/MNIST/raw")
          out_dir.mkdir(parents=True, exist_ok=True)

          for filename in files:
              target = out_dir / filename
              if target.exists():
                  continue
              urlretrieve(base + filename, target)
          PY

      - name: Run QA meta-validator in clean archive tree
        run: |
          tmp_dir="$(mktemp -d)"
          git archive HEAD | tar -x -C "$tmp_dir"
          mkdir -p "$tmp_dir/data/MNIST/raw"
          cp data/MNIST/raw/*.gz "$tmp_dir/data/MNIST/raw/"
          cd "$tmp_dir/qa_alphageometry_ptolemy"
          python qa_meta_validator.py

  qa-validators:
    needs: qa-clean-tree-meta-validator
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: qa_alphageometry_ptolemy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r ../requirements-dev.txt

      - name: Fetch MNIST raw files for Level-3 recompute
        run: |
          mkdir -p ../data/MNIST/raw
          python - <<'PY'
          from pathlib import Path
          from urllib.request import urlretrieve

          base = "https://storage.googleapis.com/cvdf-datasets/mnist/"
          files = [
              "train-images-idx3-ubyte.gz",
              "train-labels-idx1-ubyte.gz",
              "t10k-images-idx3-ubyte.gz",
              "t10k-labels-idx1-ubyte.gz",
          ]

          out_dir = Path("../data/MNIST/raw")
          out_dir.mkdir(parents=True, exist_ok=True)

          for filename in files:
              target = out_dir / filename
              if target.exists():
                  continue
              urlretrieve(base + filename, target)
          PY

      - name: Run QA meta-validator (tetrad + conjectures + FST)
        run: python qa_meta_validator.py

      - name: Run conjecture core checks
        run: python qa_conjecture_core.py

      - name: Run FST validator checks
        run: python qa_fst/qa_fst_validate.py

      - name: Run Agent Security Kernel self-tests
        working-directory: .
        run: python qa_agent_security/qa_agent_security.py

      - name: Run Tool Runner self-tests
        working-directory: .
        run: python -m qa_agent_security.tool_runner

      - name: Run Agent Security Kernel pytest suite
        working-directory: .
        run: python -m pytest qa_agent_security/tests/ -q --override-ini="testpaths=qa_agent_security/tests" --override-ini="python_files=test_*.py"

      - name: Run QA Probes (certified obstruction theorems)
        working-directory: .
        run: python -m pytest qa_probes/ -v --override-ini="testpaths=qa_probes" --override-ini="python_files=test_*.py"

      - name: Run Core System Stack validator
        run: python certs/qa_core_stack_validate.py
