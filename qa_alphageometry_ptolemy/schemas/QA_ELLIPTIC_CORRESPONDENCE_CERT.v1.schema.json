{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "QA_ELLIPTIC_CORRESPONDENCE_CERT.v1.schema.json",
  "title": "QA Elliptic Correspondence Certificate v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "certificate_id",
    "certificate_type",
    "timestamp",
    "version",
    "schema",
    "success",
    "generator_set"
  ],
  "properties": {
    "certificate_id": { "type": "string", "minLength": 1 },
    "certificate_type": { "type": "string", "const": "ELLIPTIC_CORRESPONDENCE_CERT" },
    "timestamp": { "type": "string", "minLength": 1 },
    "version": { "type": "string", "minLength": 1 },
    "schema": { "type": "string", "const": "QA_ELLIPTIC_CORRESPONDENCE_CERT.v1" },
    "success": { "type": "boolean" },
    "generator_set": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "enum": [
          "g_plus_r0",
          "g_plus_r1",
          "g_plus_r2",
          "g_minus_r0",
          "g_minus_r1",
          "g_minus_r2"
        ]
      }
    },
    "state_descriptor": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "state_space",
        "sqrt_branch",
        "cubic_root_order",
        "radius_bound_u",
        "radius_bound_v",
        "cut_state"
      ],
      "properties": {
        "state_space": { "type": "string", "minLength": 1 },
        "sqrt_branch": { "type": "string", "minLength": 1 },
        "cubic_root_order": { "type": "string", "minLength": 1 },
        "radius_bound_u": { "$ref": "#/definitions/scalar" },
        "radius_bound_v": { "$ref": "#/definitions/scalar" },
        "cut_state": {
          "type": "object",
          "additionalProperties": false,
          "required": ["sqrt_cut", "cubic_label"],
          "properties": {
            "sqrt_cut": { "type": "string", "minLength": 1 },
            "cubic_label": { "type": "string", "minLength": 1 }
          }
        }
      }
    },
    "topology_witness": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "branching_factor_declared",
        "steps_executed",
        "ramification_hit_count",
        "monodromy_event_count",
        "cut_cross_count",
        "escape_observed",
        "max_norm_u",
        "max_norm_v"
      ],
      "properties": {
        "branching_factor_declared": { "type": "integer", "minimum": 1 },
        "steps_executed": { "type": "integer", "minimum": 0 },
        "ramification_hit_count": { "type": "integer", "minimum": 0 },
        "monodromy_event_count": { "type": "integer", "minimum": 0 },
        "cut_cross_count": { "type": "integer", "minimum": 0 },
        "escape_observed": { "type": "boolean" },
        "max_norm_u": { "$ref": "#/definitions/scalar" },
        "max_norm_v": { "$ref": "#/definitions/scalar" }
      }
    },
    "invariants": {
      "type": "object",
      "additionalProperties": false,
      "required": ["curve_constraint", "determinism", "cut_consistency", "trace_complete"],
      "properties": {
        "curve_constraint": { "type": "boolean" },
        "determinism": { "type": "boolean" },
        "cut_consistency": { "type": "boolean" },
        "trace_complete": { "type": "boolean" }
      }
    },
    "recompute_inputs": {
      "type": "object",
      "additionalProperties": false,
      "required": ["trace_schema", "trace_digest", "initial_state", "transition_trace"],
      "properties": {
        "trace_schema": { "type": "string", "const": "QA_ELLIPTIC_CORRESPONDENCE_TRACE.v1" },
        "trace_digest": { "type": "string", "pattern": "^sha256:[0-9a-f]{64}$" },
        "initial_state": {
          "type": "object",
          "additionalProperties": false,
          "required": ["u_re", "u_im", "sheet", "branch_index"],
          "properties": {
            "u_re": { "$ref": "#/definitions/scalar" },
            "u_im": { "$ref": "#/definitions/scalar" },
            "sheet": { "type": "string", "enum": ["plus", "minus"] },
            "branch_index": { "type": "integer", "minimum": 0, "maximum": 2 }
          }
        },
        "transition_trace": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/trace_step" }
        }
      }
    },
    "failure_mode": {
      "type": "string",
      "enum": [
        "NONFINITE_INPUT",
        "SQRT_BRANCH_UNDEFINED",
        "SQRT_CUT_CROSS_DISALLOWED",
        "CUBIC_SOLVE_FAILED",
        "RAMIFICATION_HIT",
        "MULTIROOT_DEGENERATE",
        "CUTSTATE_UPDATE_FAILED",
        "MONODROMY_EVENT_DETECTED",
        "ESCAPE",
        "MAX_ITER_REACHED"
      ]
    },
    "failure_witness": {
      "type": "object",
      "additionalProperties": true
    },
    "qa_interpretation": {
      "type": "object",
      "additionalProperties": true
    }
  },
  "allOf": [
    {
      "if": { "properties": { "success": { "const": true } } },
      "then": { "required": ["state_descriptor", "topology_witness", "invariants", "recompute_inputs"] }
    },
    {
      "if": { "properties": { "success": { "const": false } } },
      "then": { "required": ["failure_mode", "failure_witness"] }
    }
  ],
  "definitions": {
    "scalar": {
      "anyOf": [
        { "type": "integer" },
        { "type": "string", "pattern": "^-?[0-9]+(/[0-9]+)?$" }
      ]
    },
    "trace_step": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "step_index",
        "generator",
        "u_in_re",
        "u_in_im",
        "sheet_in",
        "branch_index_in",
        "u_out_re",
        "u_out_im",
        "sheet_out",
        "branch_index_out",
        "curve_residual_abs",
        "status",
        "fail_type",
        "monodromy_event",
        "cut_crossed"
      ],
      "properties": {
        "step_index": { "type": "integer", "minimum": 1 },
        "generator": {
          "type": "string",
          "enum": [
            "g_plus_r0",
            "g_plus_r1",
            "g_plus_r2",
            "g_minus_r0",
            "g_minus_r1",
            "g_minus_r2"
          ]
        },
        "u_in_re": { "$ref": "#/definitions/scalar" },
        "u_in_im": { "$ref": "#/definitions/scalar" },
        "sheet_in": { "type": "string", "enum": ["plus", "minus"] },
        "branch_index_in": { "type": "integer", "minimum": 0, "maximum": 2 },
        "u_out_re": { "$ref": "#/definitions/scalar" },
        "u_out_im": { "$ref": "#/definitions/scalar" },
        "sheet_out": { "type": "string", "enum": ["plus", "minus"] },
        "branch_index_out": { "type": "integer", "minimum": 0, "maximum": 2 },
        "curve_residual_abs": { "$ref": "#/definitions/scalar" },
        "status": { "type": "string", "enum": ["ok", "fail"] },
        "fail_type": {
          "type": "string",
          "enum": [
            "",
            "NONFINITE_INPUT",
            "SQRT_BRANCH_UNDEFINED",
            "SQRT_CUT_CROSS_DISALLOWED",
            "CUBIC_SOLVE_FAILED",
            "RAMIFICATION_HIT",
            "MULTIROOT_DEGENERATE",
            "CUTSTATE_UPDATE_FAILED",
            "MONODROMY_EVENT_DETECTED",
            "ESCAPE",
            "MAX_ITER_REACHED"
          ]
        },
        "monodromy_event": { "type": "boolean" },
        "cut_crossed": { "type": "boolean" }
      }
    }
  }
}
